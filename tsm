#!/bin/bash

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tsm"
LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/tsm/logs"
mkdir -p "$CONFIG_DIR" "$LOG_DIR"

TSM_DIRS_CMD_DEFAULT='{
    echo "$HOME"
    find "$HOME" -maxdepth 5 -name .git -type d 2>/dev/null | sed "s|/.git$||"
}'

usage() {
  echo "Tmux Session Manager"
  echo ""
  echo "Usage: tsm [session] [options]"
  echo ""
  echo "Options:"
  echo "  -h, --help              Show this help message"
  echo "  -c, --configured [name] Browse configured sessions with fzf, or start session if provided"
  echo "  -d, --dir [path]        Browse directories with fzf, or start session at path if provided"
  echo "  -z, --zoxide [query]    Browse zoxide entries with fzf, or query zoxide if provided"
  echo "  -k, --kill [name]       Run kill(), if it exists, and kill the session"
  echo "  -l, --logs [name]       Browse all log files, or for named session if provided"
  echo ""
  echo "Examples:"
  echo "  tsm                Browse active sessions with fzf"
  echo "  tsm myproject      Switch to active session"
  echo "  tsm -c             Browse configured sessions with fzf"
  echo "  tsm -c myproject   Start configured session"
  echo "  tsm -d             Browse directories with fzf (\$HOME + git repos)"
  echo "  tsm -d ~/projects  Start session at ~/projects"
  echo "  tsm -z             Browse zoxide entries interactively"
  echo "  tsm -z proj        Start session at best zoxide match for 'proj'"
  echo "  tsm -k             Select session to kill with fzf"
  echo "  tsm -k myproject   Kill session"
  echo "  tsm -l             Browse all log files with fzf"
  echo "  tsm -l myproject   Browse log files for named session with fzf"
  echo ""
  echo "Configuration:"
  echo "  Sessions are configured in \$HOME/.config/tsm/<session-name>/"
  echo ""
  echo "  main.sh   Script containing session functions:"
  echo "            - start() Required function that creates the tmux session."
  echo "                       tsm automatically attaches after this completes."
  echo "                       Receives the session log directory as \$1."
  echo "            - kill()  Optional function that runs asynchronously when session is killed."
  echo "                       Use this for cleanup tasks like stopping services."
  echo "                       Receives the session log directory as \$1."
  echo ""
  echo "            Log directory: \$HOME/.local/state/tsm/logs/<session-name>/"
  echo "            tsm writes to tsm.log in this directory. Custom logs can be"
  echo "            written here too, e.g.: some_cmd > \"\$1/other_service.log\" 2>&1"
  echo ""
  echo "Environment Variables:"
  echo "  TSM_DIRS_CMD  Command to generate directories for 'tsm -d'."
  echo "                The command is evaluated at runtime and piped to fzf."
  echo ""
  echo "                Default (when unset): \$HOME + git repos within 4 levels"
}

get_active_sessions() {
  tmux ls 2>/dev/null | awk -F: '{print $1}'
}

active_session() {
  local session="$1"

  # If no session provided, use fzf to select from active sessions
  if [ -z "$session" ]; then
    local active_sessions
    active_sessions=$(get_active_sessions)

    if [ -z "$active_sessions" ]; then
      echo "No active sessions"
      exit 1
    fi

    session=$(echo "$active_sessions" | fzf --cycle --prompt "> " --header "Select active session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  if ! tmux has-session -t "$session" 2>/dev/null; then
    echo "Error: Session '$session' is not running"
    exit 1
  fi

  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session"
  else
    tmux attach-session -t "$session"
  fi
}

kill_session() {
  local session="$1"

  # If no session provided, use fzf to select from active sessions
  if [ -z "$session" ]; then
    local active_sessions
    active_sessions=$(get_active_sessions)

    if [ -z "$active_sessions" ]; then
      echo "No active sessions to kill"
      exit 1
    fi

    session=$(echo "$active_sessions" | fzf --cycle --prompt "> " --header "Kill session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  if ! tmux has-session -t "$session" 2>/dev/null; then
    echo "Error: Session '$session' is not running"
    exit 1
  fi

  local log_dir="$LOG_DIR/$session"
  local log_file="$log_dir/tsm.log"
  mkdir -p "$log_dir"

  local session_dir="$CONFIG_DIR/$session"

  # Run kill function in background if it exists in main.sh
  if [ -f "$session_dir/main.sh" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Killing session '$session'" > "$log_file"
    nohup bash -c "source '$session_dir/main.sh' && declare -F kill &>/dev/null && kill '$log_dir'" >> "$log_file" 2>&1 &
  fi

  tmux kill-session -t "$session"
}

configured_session() {
  local session="$1"

  if [ ! -d "$CONFIG_DIR" ]; then
    echo "No sessions configured. Create directories in $CONFIG_DIR"
    exit 1
  fi

  # If no session provided, use fzf to select from configured sessions
  if [ -z "$session" ]; then
    local configured_sessions
    configured_sessions=$(for dir in "$CONFIG_DIR"/*/; do [ -d "$dir" ] && echo "$(basename "$dir")"; done)

    if [ -z "$configured_sessions" ]; then
      echo "No configured sessions"
      exit 1
    fi

    session=$(echo "$configured_sessions" | fzf --cycle --prompt "> " --header "Select configured session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  local session_dir="$CONFIG_DIR/$session"

  if [ ! -d "$session_dir" ]; then
    echo "Error: Session '$session' not found in $CONFIG_DIR"
    exit 1
  fi

  if [ ! -f "$session_dir/main.sh" ]; then
    echo "Error: No main.sh found for session '$session'"
    exit 1
  fi

  # Verify start function exists
  if ! bash -c "source '$session_dir/main.sh' && declare -F start" &>/dev/null; then
    echo "Error: No start function defined in main.sh for session '$session'"
    exit 1
  fi

  local log_dir="$LOG_DIR/$session"
  local log_file="$log_dir/tsm.log"
  mkdir -p "$log_dir"

  # Check if session already exists
  if tmux has-session -t "$session" 2>/dev/null; then
    echo "Session '$session' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session"
    else
      tmux attach-session -t "$session"
    fi
  else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting session '$session'" > "$log_file"
    bash -c "set -m; source '$session_dir/main.sh' && start '$log_dir'" >> "$log_file" 2>&1
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session"
    else
      tmux attach-session -t "$session"
    fi
  fi
}

dir_session() {
  local target_dir="$1"
  local selected

  if [ -n "$target_dir" ]; then
    # Path provided, use it directly
    # Expand tilde if present
    selected="${target_dir/#\~/$HOME}"

    if [ ! -d "$selected" ]; then
      echo "Error: Directory '$selected' does not exist"
      exit 1
    fi
  else
    # No path provided, use fzf to select from TSM_DIRS_CMD or default
    local dirs_cmd="${TSM_DIRS_CMD:-$TSM_DIRS_CMD_DEFAULT}"

    # Use process substitution to allow killing the directory generator after fzf exits
    exec 3< <(eval "$dirs_cmd")
    local dirs_pid=$!
    selected=$(fzf --cycle --prompt "> " --header "Select directory" <&3)
    kill "$dirs_pid" 2>/dev/null
    wait "$dirs_pid" 2>/dev/null
    exec 3<&-

    if [ -z "$selected" ]; then
      echo "No directory selected"
      exit 0
    fi
  fi

  # Resolve to absolute path
  selected=$(cd "$selected" && pwd -P)

  local session_name
  # Only allow alphanumeric, dash, underscore (avoid tmux parsing issues with dots, colons, etc.)
  session_name=$(basename "$selected" | tr -c 'a-zA-Z0-9_\-\n' '_')

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    echo "Starting new session '$session_name' in $selected..."
    if [ -n "$TMUX" ]; then
      tmux new-session -d -s "$session_name" -c "$selected"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$selected"
    fi
  fi
}

zoxide_dir_session() {
  local query="$1"
  local selected

  if ! command -v zoxide &> /dev/null; then
    echo "Error: zoxide is not installed"
    exit 1
  fi

  if [ -n "$query" ]; then
    # Query provided, use zoxide query directly
    selected=$(zoxide query "$query" 2>/dev/null)

    if [ -z "$selected" ]; then
      echo "Error: No zoxide match found for '$query'"
      exit 1
    fi
  else
    # No query provided, use zoxide query -i for interactive selection
    selected=$(zoxide query -i 2>/dev/null)

    if [ -z "$selected" ]; then
      echo "No directory selected"
      exit 0
    fi
  fi

  # Resolve to absolute path
  selected=$(cd "$selected" && pwd -P)

  local session_name
  # Only allow alphanumeric, dash, underscore (avoid tmux parsing issues with dots, colons, etc.)
  session_name=$(basename "$selected" | tr -c 'a-zA-Z0-9_\-\n' '_')

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    echo "Starting new session '$session_name' in $selected..."
    if [ -n "$TMUX" ]; then
      tmux new-session -d -s "$session_name" -c "$selected"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$selected"
    fi
  fi
}

browse_logs() {
  local session="$1"

  local search_dir
  if [ -n "$session" ]; then
    search_dir="$LOG_DIR/$session"
    if [ ! -d "$search_dir" ]; then
      echo "Error: No log directory found for session '$session'"
      exit 1
    fi
  else
    search_dir="$LOG_DIR"
  fi

  local log_files
  log_files=$(find "$search_dir" -type f -name '*.log' 2>/dev/null | sed "s|^$LOG_DIR/||" | sort)

  if [ -z "$log_files" ]; then
    echo "No log files found"
    exit 1
  fi

  local selected
  selected=$(echo "$log_files" | fzf \
    --cycle \
    --bind=ctrl-d:preview-half-page-down \
    --bind=ctrl-u:preview-half-page-up \
    --prompt "> " \
    --header $'Select file to tail log :: \e[33mctrl-d\e[0m to \e[31mpreview page down\e[0m | \e[33mctrl-u\e[0m to \e[31mpreview page up\e[0m' \
    --preview "tail -n 100000 -f '$LOG_DIR/{}'" \
    --preview-window follow)

  if [ -z "$selected" ]; then
    echo "No log file selected"
    exit 0
  fi

  tail -n 1000 -f "$LOG_DIR/$selected"
}

# Parse arguments
if [ $# -eq 0 ]; then
  active_session
  exit 0
fi

case "$1" in
  -c|--configured)
    configured_session "$2"
    ;;
  -k|--kill)
    kill_session "$2"
    ;;
  -l|--logs)
    browse_logs "$2"
    ;;
  -d|--dir)
    dir_session "$2"
    ;;
  -z|--zoxide)
    zoxide_dir_session "$2"
    ;;
  -h|--help)
    usage
    ;;
  -*)
    echo "Error: Unknown option '$1'"
    usage
    exit 1
    ;;
  *)
    active_session "$1"
    ;;
esac
