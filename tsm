#!/bin/bash

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tsm"
mkdir -p "$CONFIG_DIR"

TSM_DIRS_CMD_DEFAULT='{
    echo "$HOME"
    find "$HOME" -maxdepth 4 -name .git -type d 2>/dev/null | sed "s|/.git$||"
}'

usage() {
  echo "Tmux Session Manager"
  echo ""
  echo "Usage: tsm [session] [options]"
  echo ""
  echo "Options:"
  echo "  -h, --help              Show this help message"
  echo "  -c, --configured [name] Browse configured sessions with fzf, or start session if provided"
  echo "  -d, --dir [path]        Browse directories with fzf, or start session at path if provided"
  echo "  -z, --zoxide [query]    Browse zoxide entries with fzf, or query zoxide if provided"
  echo "  -k, --kill [name]       Run kill.sh, if it exists, and kill the session"
  echo ""
  echo "Examples:"
  echo "  tsm                Browse active sessions with fzf"
  echo "  tsm myproject      Switch to active session"
  echo "  tsm -c             Browse configured sessions with fzf"
  echo "  tsm -c myproject   Start configured session"
  echo "  tsm -d             Browse directories with fzf (\$HOME + git repos)"
  echo "  tsm -d ~/projects  Start session at ~/projects"
  echo "  tsm -z             Browse zoxide entries interactively"
  echo "  tsm -z proj        Start session at best zoxide match for 'proj'"
  echo "  tsm -k             Select session to kill with fzf"
  echo "  tsm -k myproject   Kill session"
  echo ""
  echo "Configuration:"
  echo "  Sessions are configured in \$HOME/.config/tsm/<session-name>/"
  echo ""
  echo "  start.sh  Required script that runs when starting a session."
  echo "            Use this to create tmux windows, panes, and run commands."
  echo ""
  echo "  kill.sh   Optional script that runs asynchronously when session is killed."
  echo "            Use this for cleanup tasks like stopping services."
  echo ""
  echo "Environment Variables:"
  echo "  TSM_DIRS_CMD  Command to generate directories for 'tsm -d'."
  echo "                The command is evaluated at runtime and piped to fzf."
  echo ""
  echo "                Default (when unset): \$HOME + git repos within 3 levels"
}

get_active_sessions() {
  tmux ls 2>/dev/null | awk -F: '{print $1}'
}

active_session() {
  local session="$1"

  # If no session provided, use fzf to select from active sessions
  if [ -z "$session" ]; then
    local active_sessions
    active_sessions=$(get_active_sessions)

    if [ -z "$active_sessions" ]; then
      echo "No active sessions"
      exit 1
    fi

    session=$(echo "$active_sessions" | fzf --prompt "> " --header "Select active session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  if ! tmux has-session -t "$session" 2>/dev/null; then
    echo "Error: Session '$session' is not running"
    exit 1
  fi

  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session"
  else
    tmux attach-session -t "$session"
  fi
}

stop_session() {
  local session="$1"

  # If no session provided, use fzf to select from active sessions
  if [ -z "$session" ]; then
    local active_sessions
    active_sessions=$(get_active_sessions)

    if [ -z "$active_sessions" ]; then
      echo "No active sessions to kill"
      exit 1
    fi

    session=$(echo "$active_sessions" | fzf --prompt "> " --header "Kill session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  if ! tmux has-session -t "$session" 2>/dev/null; then
    echo "Error: Session '$session' is not running"
    exit 1
  fi

  local session_dir="$CONFIG_DIR/$session"

  # Run kill.sh in background if it exists
  if [ -f "$session_dir/kill.sh" ]; then
    nohup bash "$session_dir/kill.sh" >/dev/null 2>&1 &
  fi

  tmux kill-session -t "$session"
}

configured_session() {
  local session="$1"

  if [ ! -d "$CONFIG_DIR" ]; then
    echo "No sessions configured. Create directories in $CONFIG_DIR"
    exit 1
  fi

  # If no session provided, use fzf to select from configured sessions
  if [ -z "$session" ]; then
    local configured_sessions
    configured_sessions=$(for dir in "$CONFIG_DIR"/*/; do [ -d "$dir" ] && echo "$(basename "$dir")"; done)

    if [ -z "$configured_sessions" ]; then
      echo "No configured sessions"
      exit 1
    fi

    session=$(echo "$configured_sessions" | fzf --prompt "> " --header "Select configured session")

    if [ -z "$session" ]; then
      echo "No session selected"
      exit 0
    fi
  fi

  local session_dir="$CONFIG_DIR/$session"

  if [ ! -d "$session_dir" ]; then
    echo "Error: Session '$session' not found in $CONFIG_DIR"
    exit 1
  fi

  if [ ! -f "$session_dir/start.sh" ]; then
    echo "Error: No start.sh found for session '$session'"
    exit 1
  fi

  # Check if session already exists
  if tmux has-session -t "$session" 2>/dev/null; then
    echo "Session '$session' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session"
    else
      tmux attach-session -t "$session"
    fi
  else
    echo "Starting session '$session'..."
    bash "$session_dir/start.sh"
  fi
}

dir_session() {
  local target_dir="$1"
  local selected

  if [ -n "$target_dir" ]; then
    # Path provided, use it directly
    # Expand tilde if present
    selected="${target_dir/#\~/$HOME}"

    if [ ! -d "$selected" ]; then
      echo "Error: Directory '$selected' does not exist"
      exit 1
    fi
  else
    # No path provided, use fzf to select from TSM_DIRS_CMD or default
    local dirs_cmd="${TSM_DIRS_CMD:-$TSM_DIRS_CMD_DEFAULT}"
    selected=$(eval "$dirs_cmd" | fzf --prompt "> " --header "Select directory")

    if [ -z "$selected" ]; then
      echo "No directory selected"
      exit 0
    fi
  fi

  # Resolve to absolute path
  selected=$(cd "$selected" && pwd -P)

  local session_name
  # Only allow alphanumeric, dash, underscore (avoid tmux parsing issues with dots, colons, etc.)
  session_name=$(basename "$selected" | tr -c 'a-zA-Z0-9_-\n' '_')

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    echo "Starting new session '$session_name' in $selected..."
    if [ -n "$TMUX" ]; then
      tmux new-session -d -s "$session_name" -c "$selected"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$selected"
    fi
  fi
}

zoxide_dir_session() {
  local query="$1"
  local selected

  if ! command -v zoxide &> /dev/null; then
    echo "Error: zoxide is not installed"
    exit 1
  fi

  if [ -n "$query" ]; then
    # Query provided, use zoxide query directly
    selected=$(zoxide query "$query" 2>/dev/null)

    if [ -z "$selected" ]; then
      echo "Error: No zoxide match found for '$query'"
      exit 1
    fi
  else
    # No query provided, use zoxide query -i for interactive selection
    selected=$(zoxide query -i 2>/dev/null)

    if [ -z "$selected" ]; then
      echo "No directory selected"
      exit 0
    fi
  fi

  # Resolve to absolute path
  selected=$(cd "$selected" && pwd -P)

  local session_name
  # Only allow alphanumeric, dash, underscore (avoid tmux parsing issues with dots, colons, etc.)
  session_name=$(basename "$selected" | tr -c 'a-zA-Z0-9_-\n' '_')

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    echo "Starting new session '$session_name' in $selected..."
    if [ -n "$TMUX" ]; then
      tmux new-session -d -s "$session_name" -c "$selected"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$selected"
    fi
  fi
}

# Parse arguments
if [ $# -eq 0 ]; then
  active_session
  exit 0
fi

case "$1" in
  -c|--configured)
    configured_session "$2"
    ;;
  -k|--kill)
    stop_session "$2"
    ;;
  -d|--dir)
    dir_session "$2"
    ;;
  -z|--zoxide)
    zoxide_dir_session "$2"
    ;;
  -h|--help)
    usage
    ;;
  -*)
    echo "Error: Unknown option '$1'"
    usage
    exit 1
    ;;
  *)
    active_session "$1"
    ;;
esac
